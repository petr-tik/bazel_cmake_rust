#+TITLE: Todo

* cc_library and tests that rely on cmake lib and rust lib
Going to learn me a Bazel by wiring cmake, native cc and rules_rust-based
libraries and build targets.

In the end, i would like to be able to build cpp libraries and tests that
use APIs from third-party cmake-built libraries and in-repo rust libraries.

** DONE Get a cmake lib to build in bazel
the lib_name attribute in the cmake starlark function has to match the `add_library($NAME)` passed to cmake.

Now that it does - we are all good.

** DONE Create a cc_library

*** DONE get it to build

*** DONE Create a binary that calls native cc_lib and cmake lib

**** DONE add a dependency on the cmake lib
call it in the internals

** DONE create a rust library with ffi that exposes a function

*** DONE create a rust test executable

*** DONE make the rust public ABI/API return an int

** DONE add a pure function to cmake lib that takes an int

** DONE create a cc_test that chains calls to rust_lib and then cmake_lib
assert the outcome as expected

** DONE add an expect throw test for a rust panic
*** How do you view full rust backtrace when it's linked into a cc_test?
bazel test --test_output all //... --test_env=RUST_BACKTRACE=full

even better - you can set an env var for a particular test
*** Rust panics when linked to cc_library
gtest EXPECT_ANY_THROW doesn't catch it properly, so we need a different kind of test

** DONE Restrict targets' publicity to more private by default
** TODO define proper toolchains instead of env vars
https://bazel.build/tutorials/cc-toolchain-config

*** TODO define a gcc-7 toolchain
gcc-7 and g++-7 as env vars

*** TODO define a clang-11 toolchain
works as env vars too

*** TODO use mold linker in the toolchain and compare link times

** TODO Add a dependency on an external cmake-buildable lib for formatting
https://github.com/fmtlib/fmt

pretty-print a string in the current cmake lib
#+begin_src cpp
#include <fmt/color.h>

fmt::print(fg(fmt::color::crimson) | fmt::emphasis::bold, "Hello, {}!\n", "world");
#+end_src

** TODO modify a string in rust then pass it to cc_library to fmt pretty print

** TODO add cxx-rs and link it with a third-party cmake lib

** TODO get clangd working for cpp
https://github.com/hedronvision/bazel-compile-commands-extractor
** TODO get rust-analyzer working for rust lib
** TODO add python tests to this
